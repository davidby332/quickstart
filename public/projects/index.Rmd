---
title: "Embedding a shiny app in blogdown"
# author: "Brett Ory"

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(shiny)
library(widgetframe)
library(tidyr)
library(ggmap)
library(maps)
library(mapdata)
library(mapproj)
library(data.table)
```

From a technical standpoint I took this project on to get some practice with APIs, refresh my SQL skills and scraping. I also find the opioid epidemic fascinating rarely has a drug class had such a profound and widespread effect on people's lives.

<br> Data

Many states have created their own dashboards to track the opioid crisis and give some historical persepctive. California is a great example with users able to look at data covering hospitalizations and deaths going back to 2008. Arizona has it's own real time dashboard. However, the limitation of both these dashboards is the timeframe. While the opioid crisis became prominenet in the media in 2014 after the Washington Post expose on West Virginia. 

To overcome this lack of data for earlier years we can use Medicaid's State Drug Utilization Data. The dataset has for each quarter starting in 1991 Q1 the number of prescriptions and units dispensed through each state's Medicaid program. Another advantage of this data is that Medicaid has done a great job of cleaning the data and providing it in an easily accesible way for the public. The drawback of this is that it only covers Medicaid which accounts for roughly 20% of American's health insurance. On the flip side to access to Medicaid tyopically limited to thos with low incomes, a group that were disproportianely affected by the opioid crisis.

While the SDUD does not directly identify which drugs are opioids the CDC has provided a crosswalk with the NDCs of what it considers to be opioids. Merging this onto our SDUD dataset gives us all the opioids prescribed through Medicaid.

<br> Prescriptions over time

The app below pulls data from the SDUD API and allows you to see for each state the number of prescriptions, units and MME over time. If you prefer you can switch from raw totals to market share.

<br>

<iframe width="800" height="800" scrolling="no" frameborder="no"  src="https://davidby332.shinyapps.io/opioids_r/"> </iframe> 

Looking through at different states you may have noticed kinks in the data around 2005, 2010, 2014. The first kink in 2005 aligns with the creation of Medicare Part D. Prior to the creation of Medicare Part D some low income elderly would receive pharmacy benefits through Medicaid. After the creation of Medicare Part D, Medicaid became the "provider of last resort". What we see in 2010 is likely an early effect of the affordable care act, the act changed the way that Medicaid reported prescriptions to the government to ensure full reimbursement. Finally in 2014 many states expanded Medicaid. One conclusion that you may be tempted to draw from this is that expanding Medicaid made the opioid crisis worse. However, what matters to us is the opioids per beneficiary  which as you can see implies a different conclusion.

Within states you may have noticed that Hydrocodone-Acetaminophen and Oxycodone-Acetaminophen were the top prescribed opioids. One exception is New Hampshire which had a surprisingly even split over which opioids their Medicaid beneficiaries were prescribed. To illustrate this trend in Hydrocodone and Oxycodone-Acetaminophen is the map below that shows which states had each drug as  their number 1 prescribed opioid.

You may be wondering where is fentanyl in each of these graphs. Fentanyl is an incredibly powerful opioid even low doses can put  users into a coma and as such the drug received a good amount of media coverage. However, under Medicaid it's rarely prescribed and there could be many reasons for this. Fentanyl has been available in a patch form since XX and as lollipop since YY. The patch is a slow release patch so you're .... The lollipop was released after the U.S. became aware of the opioid crisis and trends prescriptions were decreasing.

```{r, include = FALSE}
source('/Users/david/Library/Mobile Documents/com~apple~CloudDocs/Data science/opioids_R/opioids_R/rank_maps.R', local = knitr::knit_global())
```

```{r}
rank_map_plot
```

<br> Deaths from Opioids

One adverse effect of taking opioids is death and much attention has been paid to the death toll from opioids. For data on this we can use the Multiple Deaths Database from CDC Wonder. CDC Wonder has some great datasets and its fairly user  friendly. From a data stand point it allows you to request deaths data by various location options and time  periods. For this exercise again I'm going to look only at deaths in states. We could go to a more granular level by county but at that point we hit data suppression.

The app below uses datas scraped from the CDC website to show opioid prescriptions per XX as well as deaths. In the second tab compares the two and shows the relationship.

INSERT SECOND APP HERE

As you can see in many cases the correlation between opioid prescribing and deaths is non-existent. What this tells us that just prescribing opioids is unlikely to be a good indiciator of how many die. This data is at an aggregate level  which may be hiding discrepancies in intensity of prescribing. For example 1 prescription for 100 people and 100 prescriptions for one person with the other 99 are likely to have very different effects. To analyze how likely opioids are to lead to death we'd need Medical claims data.

All the code needed to generate the content of this is in my github and I'll continue to update as new quarters of data get released.
